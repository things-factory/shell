#!/usr/bin/env node

'use strict'

const args = require('args')
const path = require('path')

const createConnection = require('typeorm').createConnection
const appRootPath = require('app-root-path').path

let ormconfig

try {
  ormconfig = require(path.resolve(appRootPath, 'ormconfig'))
} catch (e) {
  ormconfig = require('@things-factory/shell/ormconfig')
}

createConnection({
  ...ormconfig,
  logging: true
}).then(async (connection, ...others) => {
  args.option('undo', 'Reverts last executed migration')
  const flags = args.parse(process.argv)

  console.log('Database connection established')

  if (flags.undo) {
    await connection.undoLastMigration()
  } else {
    await connection.runMigrations()
  }

  await connection.close()
  console.log('Database Migration Done.')

  /*
   * 원인은 알 수 없으나 migration 후 프로세스가 종료되지 않는 경우가 있기 때문에,
   * 강제로 종료시키는 코드를 추가함
   * 특히, board-ui migration 시에 항상 발생함.
   */
  process.exit(0)
})
