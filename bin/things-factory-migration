#!/usr/bin/env node

'use strict'

const args = require('args')
const path = require('path')

const createConnection = require('typeorm').createConnection
const appRootPath = require('app-root-path').path

let ormconfig

try {
  ormconfig = require(path.resolve(appRootPath, 'ormconfig'))
} catch (e) {
  ormconfig = require('@things-factory/shell/ormconfig')
}

createConnection({
  ...ormconfig,
  logging: true
}).then(async (connection, ...others) => {
  args.option('undo', 'Reverts last executed migration')
  const flags = args.parse(process.argv)

  console.log('Database connection established')

  if (flags.undo) {
    await connection.undoLastMigration()
  } else {
    await connection.runMigrations()
  }

  await connection.close()
  console.log('Database Migration Done.')
})
